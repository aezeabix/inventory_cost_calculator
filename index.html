<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
        window.onload = function() {
            initializeData();
        };
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .content {
            padding: 30px;
        }
        
        .formula-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .formula-section h3 {
            margin-top: 0;
            font-size: 1.3em;
        }
        
        .formula {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #333;
        }
        
        .control-group input, .control-group select {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1200px;
        }
        
        th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px 10px;
            text-align: center;
            border: 1px solid #ddd;
            background: white;
        }
        
        .input-cell {
            background: #f8f9ff !important;
        }
        
        .calculated-cell {
            background: #e8f5e8 !important;
            font-weight: 600;
            color: #2d5a2d;
        }
        
        .master-row {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%) !important;
            font-weight: bold;
        }
        
        .master-row td {
            background: transparent !important;
        }
        
        input[type="number"], input[type="date"] {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        
        input[type="text"] {
            width: 40px;
            text-align: center;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .summary-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .summary-item h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .summary-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        </div>
        
        <div class="content">
            <div class="formula-section">
                <h3>üìã ‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>
                <div class="formula">
                    <strong>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤:</strong><br>
                    [(‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠) + (‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤)] √∑ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤)
                </div>
                <div class="formula">
                    <strong>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á Master:</strong><br>
                    Œ£(‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤) √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="dateInput" value="2025-01-01">
                </div>
                <div class="control-group">
                    <label>üè™ ‡∏™‡∏≤‡∏Ç‡∏≤:</label>
                    <input type="text" id="branchInput" placeholder="A" value="A">
                </div>
                <button class="btn" onclick="addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
                <button class="btn" onclick="testExample()" style="background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
                <button class="btn btn-export" onclick="exportToCSV()">üìä Export CSV</button>
                <button class="btn" onclick="clearAll()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            
            <div class="table-container">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th style="width: 100px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th style="width: 80px;">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th style="width: 100px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th style="width: 120px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
                            <th style="width: 150px;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤<br>(‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô Master)</th>
                            <th style="width: 120px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢</th>
                            <th style="width: 150px;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢<br>‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th style="width: 120px;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà</th>
                            <th style="width: 150px;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢<br>‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th style="width: 120px;">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th style="width: 100px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            <th style="width: 80px;">‡∏•‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
            
            <div class="summary-section">
                <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Master</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <h4>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ Master</h4>
                        <div class="value" id="masterAvgCost">0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</h4>
                        <div class="value" id="totalQuantity">0</div>
                    </div>
                    <div class="summary-item">
                        <h4>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</h4>
                        <div class="value" id="totalValue">0.00</div>
                    </div>
                </div>
                
                <!-- ‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ Master -->
                <div style="margin-top: 20px; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-top: 0; margin-bottom: 15px;">üßÆ ‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ Master</h4>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; backdrop-filter: blur(10px);">
                        <div style="margin-bottom: 10px;"><strong>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ Master = Œ£(‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤) √∑ Œ£(‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤)</strong></div>
                        <div style="font-size: 12px; opacity: 0.9;">
                            <div>‚Ä¢ ‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ > 0)</div>
                            <div>‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤</div>
                        </div>
                    </div>
                    <div id="masterFormula" style="margin-top: 15px; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px;">
                        <!-- ‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>üè™ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤</h4>
                    <div id="branchSummary" style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </div>
                    
                    <!-- ‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤ -->
                    <div style="margin-top: 20px; background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: white; padding: 20px; border-radius: 10px;">
                        <h4 style="margin-top: 0; margin-bottom: 15px;">üìà ‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤</h4>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; backdrop-filter: blur(10px);">
                            <div style="margin-bottom: 10px;"><strong>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà = ((‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏¥‡∏° √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°) + (‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ √ó ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤)) √∑ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏° + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤)</strong></div>
                            <div style="font-size: 12px; opacity: 0.9;">
                                <div>‚Ä¢ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                                <div>‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                                <div>‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏° + ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ - ‡∏Ç‡∏≤‡∏¢</div>
                            </div>
                        </div>
                        <div id="branchFormula" style="margin-top: 15px; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px;">
                            <!-- ‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rowCounter = 0;
        let inventoryData = [];

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
        function initializeData() {
            const sampleData = [
                {date: '2025-01-01', branch: 'A', type: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤', inQty: 100, inCost: 100, outQty: 0, prevQty: 0, prevCost: 0, note: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'},
                {date: '2025-01-01', branch: 'B', type: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤', inQty: 50, inCost: 102, outQty: 0, prevQty: 0, prevCost: 0, note: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'},
                {date: '2025-01-02', branch: 'A', type: '‡∏Ç‡∏≤‡∏¢', inQty: 0, inCost: 100, outQty: 60, prevQty: 100, prevCost: 100, note: '‡∏Ç‡∏≤‡∏¢'},
                {date: '2025-01-02', branch: 'B', type: '‡∏Ç‡∏≤‡∏¢', inQty: 0, inCost: 102, outQty: 30, prevQty: 50, prevCost: 102, note: '‡∏Ç‡∏≤‡∏¢'},
                {date: '2025-01-03', branch: 'B', type: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤', inQty: 50, inCost: 105, outQty: 0, prevQty: 20, prevCost: 102, note: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'},
                {date: '2025-01-03', branch: 'A', type: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤', inQty: 80, inCost: 105, outQty: 0, prevQty: 40, prevCost: 100, note: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤'}
            ];

            inventoryData = [];
            sampleData.forEach(data => {
                addRowWithData(data);
            });
        }

        function addRow() {
            const date = document.getElementById('dateInput').value || '2025-01-01';
            const branch = document.getElementById('branchInput').value || 'A';
            
            addRowWithData({
                date: date,
                branch: branch,
                type: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤',
                inQty: 0,
                inCost: 100,
                outQty: 0,
                prevQty: 0,
                prevCost: 0,
                note: ''
            });
        }

        function addRowWithData(data) {
            const tableBody = document.getElementById('tableBody');
            const row = document.createElement('tr');
            row.id = `row-${rowCounter}`;
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà - ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
            const newQty = (data.prevQty + data.inQty - data.outQty);
            let newAvgCost = 0;
            
            if (newQty > 0) {
                if (data.inQty > 0 && data.type === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
                    // ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà
                    newAvgCost = ((data.prevCost * data.prevQty) + (data.inCost * data.inQty)) / (data.prevQty + data.inQty);
                } else {
                    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" - ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏¥‡∏°
                    newAvgCost = data.prevCost;
                }
            }
            
            const totalValue = newQty * newAvgCost;
            
            row.innerHTML = `
                <td><input type="date" value="${data.date}" onchange="updateCalculations()"></td>
                <td><input type="text" value="${data.branch}" onchange="updateCalculations()"></td>
                <td>
                    <select onchange="updateCalculations(); toggleFields(this)">
                        <option value="‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" ${data.type === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' ? 'selected' : ''}>‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option>
                        <option value="‡∏Ç‡∏≤‡∏¢" ${data.type === '‡∏Ç‡∏≤‡∏¢' ? 'selected' : ''}>‡∏Ç‡∏≤‡∏¢</option>
                        <option value="‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å" ${data.type === '‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å' ? 'selected' : ''}>‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å</option>
                    </select>
                </td>
                <td class="input-cell"><input type="number" value="${data.inQty}" min="0" onchange="updateCalculations()"></td>
                <td class="input-cell"><input type="number" value="${data.inCost}" min="0" step="0.01" onchange="updateCalculations()"></td>
                <td class="input-cell"><input type="number" value="${data.outQty}" min="0" onchange="updateCalculations()"></td>
                <td class="input-cell"><input type="number" value="${data.prevCost}" min="0" step="0.01" onchange="updateCalculations()" readonly style="background-color: #f0f0f0;"></td>
                <td class="calculated-cell">${newQty}</td>
                <td class="calculated-cell">${newAvgCost.toFixed(2)}</td>
                <td class="calculated-cell">${totalValue.toFixed(2)}</td>
                <td><input type="text" value="${data.note}" style="width: 80px;"></td>
                <td><button onclick="deleteRow('${row.id}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‡∏•‡∏ö</button></td>
            `;
            
            tableBody.appendChild(row);
            inventoryData.push({id: rowCounter, ...data});
            rowCounter++;
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            toggleFields(row.querySelector('select'));
            
            updateCalculations();
        }

        function deleteRow(rowId) {
            const row = document.getElementById(rowId);
            const index = parseInt(rowId.split('-')[1]);
            
            if (row) {
                row.remove();
                inventoryData = inventoryData.filter(item => item.id !== index);
                updateCalculations();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        function toggleFields(selectElement) {
            const row = selectElement.closest('tr');
            const inputs = row.getElementsByTagName('input');
            const type = selectElement.value;
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
            inputs[2].value = 0; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
            inputs[4].value = 0; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢
            
            if (type === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                inputs[2].disabled = false; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                inputs[3].disabled = false; // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                inputs[4].disabled = true;  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢
                inputs[2].style.backgroundColor = '';
                inputs[3].style.backgroundColor = '';
                inputs[4].style.backgroundColor = '#f0f0f0';
            } else if (type === '‡∏Ç‡∏≤‡∏¢') {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ç‡∏≤‡∏¢
                inputs[2].disabled = true;  // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                inputs[3].disabled = true;  // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                inputs[4].disabled = false; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢
                inputs[2].style.backgroundColor = '#f0f0f0';
                inputs[3].style.backgroundColor = '#f0f0f0';
                inputs[4].style.backgroundColor = '';
            } else if (type === '‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å') {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡πÑ‡∏î‡πâ)
                inputs[2].disabled = false; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                inputs[3].disabled = true;  // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å)
                inputs[4].disabled = false; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢
                inputs[2].style.backgroundColor = '';
                inputs[3].style.backgroundColor = '#f0f0f0';
                inputs[4].style.backgroundColor = '';
            }
            
            updateCalculations();
        }

        function updateCalculations() {
            const rows = document.getElementById('tableBody').getElementsByTagName('tr');
            const branchData = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const inputs = row.getElementsByTagName('input');
                const select = row.getElementsByTagName('select')[0];
                
                const branch = inputs[1].value || 'A';
                const type = select.value;
                const inQty = parseFloat(inputs[2].value) || 0;
                const inCost = parseFloat(inputs[3].value) || 0;
                const outQty = parseFloat(inputs[4].value) || 0;
                
                // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤")
                let prevQty = 0;
                let prevAvgCost = 0;
                
                // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                for (let j = i - 1; j >= 0; j--) {
                    const prevRow = rows[j];
                    const prevInputs = prevRow.getElementsByTagName('input');
                    const prevSelect = prevRow.getElementsByTagName('select')[0];
                    const prevBranch = prevInputs[1].value || 'A';
                    
                    if (prevBranch === branch) {
                        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                        prevQty = parseFloat(prevRow.cells[7].textContent) || 0;
                        prevAvgCost = parseFloat(prevRow.cells[8].textContent) || 0;
                        break;
                    }
                }
                
                // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                let previousReceivingAvgCost = 0;
                for (let j = i - 1; j >= 0; j--) {
                    const prevRow = rows[j];
                    const prevInputs = prevRow.getElementsByTagName('input');
                    const prevSelect = prevRow.getElementsByTagName('select')[0];
                    const prevBranch = prevInputs[1].value || 'A';
                    const prevType = prevSelect.value;
                    
                    if (prevBranch === branch && prevType === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
                        // ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                        previousReceivingAvgCost = parseFloat(prevRow.cells[8].textContent) || 0;
                        break;
                    }
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏¥‡∏•‡∏î‡πå "‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤" ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                inputs[5].value = previousReceivingAvgCost.toFixed(2);
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
                const newQty = prevQty + inQty - outQty;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
                let newAvgCost = prevAvgCost;
                if (newQty > 0) {
                    if (inQty > 0 && type === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
                        // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà
                        newAvgCost = ((prevAvgCost * prevQty) + (inCost * inQty)) / (prevQty + inQty);
                    }
                }
                
                const currentValue = newQty * newAvgCost;
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                row.cells[7].textContent = newQty;
                row.cells[8].textContent = newAvgCost.toFixed(2);
                row.cells[9].textContent = currentValue.toFixed(2);
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤)
                if (newQty >= 0) { // ‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏î‡πâ‡∏ß‡∏¢
                    branchData[branch] = {
                        quantity: newQty,
                        avgCost: newAvgCost,
                        value: currentValue,
                        rowIndex: i
                    };
                }
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ Master ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
            let totalWeightedCost = 0;
            let totalQuantity = 0;
            let totalValue = 0;
            
            Object.values(branchData).forEach(branch => {
                if (branch.quantity > 0) { // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                    totalWeightedCost += branch.avgCost * branch.quantity;
                    totalQuantity += branch.quantity;
                    totalValue += branch.value;
                }
            });
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ Master
            const masterAvgCost = totalQuantity > 0 ? totalWeightedCost / totalQuantity : 0;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            document.getElementById('masterAvgCost').textContent = masterAvgCost.toFixed(2);
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalValue').textContent = totalValue.toFixed(2);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤
            updateBranchSummary(branchData);
        }

        function exportToCSV() {
            const rows = document.getElementById('tableBody').getElementsByTagName('tr');
            let csvContent = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏™‡∏≤‡∏Ç‡∏≤,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤,‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢,‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏¥‡∏°,‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà,‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà,‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏\n";
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const inputs = row.getElementsByTagName('input');
                const select = row.getElementsByTagName('select')[0];
                const cells = row.getElementsByTagName('td');
                
                const rowData = [
                    inputs[0].value, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    inputs[1].value, // ‡∏™‡∏≤‡∏Ç‡∏≤
                    select.value, // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                    inputs[2].value, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                    inputs[3].value, // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                    inputs[4].value, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢
                    inputs[5].value, // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏¥‡∏°
                    cells[7].textContent, // ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
                    cells[8].textContent, // ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà
                    cells[9].textContent, // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                    inputs[6].value // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                ];
                
                csvContent += rowData.join(',') + '\n';
            }
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Master
            csvContent += `\n‡∏™‡∏£‡∏∏‡∏õ Master:\n`;
            csvContent += `‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ Master,${document.getElementById('masterAvgCost').textContent}\n`;
            csvContent += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°,${document.getElementById('totalQuantity').textContent}\n`;
            csvContent += `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°,${document.getElementById('totalValue').textContent}\n`;
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `inventory_calculation_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearAll() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                document.getElementById('tableBody').innerHTML = '';
                inventoryData = [];
                rowCounter = 0;
                updateCalculations();
            }
        }

        function updateBranchSummary(branchData) {
            const summaryDiv = document.getElementById('branchSummary');
            let summaryHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            
            Object.entries(branchData).forEach(([branch, data]) => {
                summaryHTML += `
                    <div style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <h5 style="margin: 0 0 10px 0; font-size: 1.2em;">‡∏™‡∏≤‡∏Ç‡∏≤ ${branch}</h5>
                        <div style="font-size: 0.9em; opacity: 0.9;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${data.quantity}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${data.avgCost.toFixed(2)}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: ${data.value.toFixed(2)}</div>
                    </div>
                `;
            });
            
            summaryHTML += '</div>';
            
            if (Object.keys(branchData).length === 0) {
                summaryHTML = '<div style="text-align: center; color: #666; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤</div>';
            }
            
            summaryDiv.innerHTML = summaryHTML;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            updateMasterFormula(branchData);
            updateBranchFormula();
        }

        function updateMasterFormula(branchData) {
            const formulaDiv = document.getElementById('masterFormula');
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠
            const activeBranches = Object.entries(branchData).filter(([branch, data]) => data.quantity > 0);
            
            if (activeBranches.length === 0) {
                formulaDiv.innerHTML = '<div style="text-align: center; opacity: 0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>';
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            let numeratorParts = [];
            let denominatorParts = [];
            let totalWeightedCost = 0;
            let totalQuantity = 0;
            
            activeBranches.forEach(([branch, data]) => {
                const weightedCost = data.avgCost * data.quantity;
                numeratorParts.push(`(${data.avgCost.toFixed(2)} √ó ${data.quantity})`);
                denominatorParts.push(`${data.quantity}`);
                totalWeightedCost += weightedCost;
                totalQuantity += data.quantity;
            });
            
            const masterAvgCost = totalQuantity > 0 ? totalWeightedCost / totalQuantity : 0;
            
            let formulaHTML = `
                <div style="margin-bottom: 10px;"><strong>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong></div>
                <div style="margin-bottom: 8px;">
                    ‡∏ï‡∏±‡∏ß‡πÄ‡∏®‡∏©: ${numeratorParts.join(' + ')} = ${totalWeightedCost.toFixed(2)}
                </div>
                <div style="margin-bottom: 8px;">
                    ‡∏ï‡∏±‡∏ß‡∏™‡πà‡∏ß‡∏ô: ${denominatorParts.join(' + ')} = ${totalQuantity}
                </div>
                <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px;">
                    <strong>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${totalWeightedCost.toFixed(2)} √∑ ${totalQuantity} = ${masterAvgCost.toFixed(2)}</strong>
                </div>
            `;
            
            formulaDiv.innerHTML = formulaHTML;
        }

        function updateBranchFormula() {
            const formulaDiv = document.getElementById('branchFormula');
            const rows = document.getElementById('tableBody').getElementsByTagName('tr');
            
            if (rows.length === 0) {
                formulaDiv.innerHTML = '<div style="text-align: center; opacity: 0.7;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>';
                return;
            }
            
            let formulaHTML = '<div style="margin-bottom: 10px;"><strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong></div>';
            
            // ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            let lastReceivingRow = null;
            let lastReceivingIndex = -1;
            
            for (let i = rows.length - 1; i >= 0; i--) {
                const row = rows[i];
                const select = row.getElementsByTagName('select')[0];
                if (select && select.value === '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') {
                    lastReceivingRow = row;
                    lastReceivingIndex = i;
                    break;
                }
            }
            
            if (lastReceivingRow) {
                const inputs = lastReceivingRow.getElementsByTagName('input');
                const branch = inputs[1].value || 'A';
                const inQty = parseFloat(inputs[2].value) || 0;
                const inCost = parseFloat(inputs[3].value) || 0;
                const prevAvgCost = parseFloat(inputs[5].value) || 0;
                const newQty = parseFloat(lastReceivingRow.cells[7].textContent) || 0;
                const newAvgCost = parseFloat(lastReceivingRow.cells[8].textContent) || 0;
                
                // ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                let prevQty = 0;
                for (let j = lastReceivingIndex - 1; j >= 0; j--) {
                    const prevRow = rows[j];
                    const prevInputs = prevRow.getElementsByTagName('input');
                    const prevBranch = prevInputs[1].value || 'A';
                    
                    if (prevBranch === branch) {
                        prevQty = parseFloat(prevRow.cells[7].textContent) || 0;
                        break;
                    }
                }
                
                const totalPrevValue = prevAvgCost * prevQty;
                const totalNewValue = inCost * inQty;
                const totalValue = totalPrevValue + totalNewValue;
                const totalQty = prevQty + inQty;
                
                formulaHTML += `
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="margin-bottom: 5px;"><strong>‡∏™‡∏≤‡∏Ç‡∏≤ ${branch} - ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lastReceivingIndex + 1}</strong></div>
                        <div style="font-size: 12px;">
                            ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏¥‡∏°: ${prevAvgCost.toFixed(2)} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°: ${prevQty}<br>
                            ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤: ${inCost.toFixed(2)} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤: ${inQty}
                        </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        ‡∏ï‡∏±‡∏ß‡πÄ‡∏®‡∏©: (${prevAvgCost.toFixed(2)} √ó ${prevQty}) + (${inCost.toFixed(2)} √ó ${inQty}) = ${totalPrevValue.toFixed(2)} + ${totalNewValue.toFixed(2)} = ${totalValue.toFixed(2)}
                    </div>
                    <div style="margin-bottom: 8px;">
                        ‡∏ï‡∏±‡∏ß‡∏™‡πà‡∏ß‡∏ô: ${prevQty} + ${inQty} = ${totalQty}
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px;">
                        <strong>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${totalValue.toFixed(2)} √∑ ${totalQty} = ${newAvgCost.toFixed(2)}</strong>
                    </div>
                `;
            } else {
                formulaHTML += '<div style="text-align: center; opacity: 0.7;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
            
            formulaDiv.innerHTML = formulaHTML;
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ
        function testExample() {
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
            document.getElementById('tableBody').innerHTML = '';
            inventoryData = [];
            rowCounter = 0;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ
            addRowWithData({
                date: '2025-01-01',
                branch: 'A',
                type: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤',
                inQty: 100,
                inCost: 100,
                outQty: 0,
                prevQty: 0,
                prevCost: 0,
                note: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1'
            });
            
            addRowWithData({
                date: '2025-01-02',
                branch: 'A',
                type: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤',
                inQty: 100,
                inCost: 102,
                outQty: 0,
                prevQty: 100,
                prevCost: 100,
                note: '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2'
            });
        }
    </script>
</body>
</html>